{% extends 'base.html' %}

{% block title %}Album - Friend Trip{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-ghost" style="padding-left: 0">
        &larr; Back to Trips
    </a>
</div>

<div class="flex-between mb-4">
    <div>
        <h1>{{ album_name }}</h1>
        <p style="color: var(--text-muted)">Shared by {{ owner_name }}</p>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <button id="toggleSelectionBtn" class="btn btn-outline" onclick="toggleSelectionMode()">
            Select Photos
        </button>
        <button onclick="downloadAllPhotos()" class="btn btn-primary">
            Download All
        </button>
    </div>
</div>

<div class="photo-grid" id="gallery">
    {% for photo in photos %}
    <div class="photo-item" data-index="{{ loop.index0 }}" data-src="{{ photo.url }}" data-id="{{ photo.id }}"
        data-filename="{{ photo.filename }}">
        <div class="selection-overlay-bg"></div>
        <div class="photo-select-overlay">
            <input type="checkbox" class="photo-select-checkbox" value="{{ photo.id }}"
                onclick="event.stopPropagation(); updateActionbar()">
        </div>

        <img src="{{ photo.url }}" alt="Photo" class="photo-img" loading="lazy">
        <div class="photo-overlay">
            <a href="{{ url_for('download_photo', photo_id=photo.id) }}" class="btn btn-primary" title="Download"
                style="padding: 0.5rem; border-radius: 50%;" onclick="event.stopPropagation()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </a>
            {% if session.get('username') == owner_name %}
            <button class="btn btn-primary" style="background:#ef4444; padding: 0.5rem; border-radius: 50%;"
                title="Delete" onclick="deletePhoto(event, {{ photo.id }})">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted);">
        No photos in this album yet.
    </div>
    {% endfor %}
</div>

<!-- Action Bar -->
<div class="action-bar" id="actionBar">
    <span style="font-weight: 600;" id="selectedCount">0 Selected</span>
    <button class="btn btn-primary" onclick="downloadSelected()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download
    </button>
    {% if session.get('username') == owner_name %}
    <button class="btn btn-primary" style="background:#ef4444;" onclick="deleteSelected()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Delete
    </button>
    {% endif %}
</div>

<!-- Lightbox Modal -->
<div class="modal-overlay" id="lightbox">
    <button class="modal-close" onclick="closeLightbox()">&times;</button>
    <div class="modal-content">
        <img src="" alt="Full view" class="modal-img" id="lightboxImg">
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Selection Logic
    const gallery = document.getElementById('gallery');
    const toggleBtn = document.getElementById('toggleSelectionBtn');
    const actionBar = document.getElementById('actionBar');
    const countSpan = document.getElementById('selectedCount');
    let isSelectionMode = false;

    function toggleSelectionMode() {
        isSelectionMode = !isSelectionMode;
        if (isSelectionMode) {
            gallery.classList.add('selection-mode');
            toggleBtn.textContent = 'Cancel Selection';
            toggleBtn.classList.remove('btn-outline');
            toggleBtn.classList.add('btn-ghost');
        } else {
            gallery.classList.remove('selection-mode');
            toggleBtn.textContent = 'Select Photos';
            toggleBtn.classList.add('btn-outline');
            toggleBtn.classList.remove('btn-ghost');
            // Clear selection
            document.querySelectorAll('.photo-select-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('.photo-item').classList.remove('selected');
            });
            updateActionbar();
        }
    }

    function updateActionbar() {
        const checked = document.querySelectorAll('.photo-select-checkbox:checked');
        const count = checked.length;

        checked.forEach(cb => cb.closest('.photo-item').classList.add('selected'));
        document.querySelectorAll('.photo-select-checkbox:not(:checked)').forEach(cb => cb.closest('.photo-item').classList.remove('selected'));

        if (count > 0) {
            actionBar.classList.add('active');
            countSpan.textContent = `${count} Selected`;
        } else {
            actionBar.classList.remove('active');
        }
    }

    // Add click listener to photo-item to toggle checkbox in selection mode
    document.querySelectorAll('.photo-item').forEach(item => {
        item.addEventListener('click', (e) => {
            if (isSelectionMode) {
                // If clicked on checkbox/button, ignore
                if (e.target.closest('input') || e.target.closest('button') || e.target.closest('a')) return;

                const checkbox = item.querySelector('.photo-select-checkbox');
                checkbox.checked = !checkbox.checked;
                updateActionbar();
            } else {
                // Lightbox logic
                if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input')) return;
                openLightbox(parseInt(item.dataset.index));
            }
        });
    });

    // Helper to download a single image
    async function downloadImage(url, filename) {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(link.href);
        } catch (e) {
            console.error("Failed to download", url, e);
        }
    }

    async function downloadAllPhotos() {
        const photos = document.querySelectorAll('.photo-item');
        if (photos.length === 0) {
            alert("No photos to download!");
            return;
        }

        if (!confirm(`Download ${photos.length} photos individually? This may prompt your browser to allow multiple downloads.`)) return;

        let delay = 0;
        for (const photo of photos) {
            const src = photo.getAttribute('data-src');
            const filename = photo.getAttribute('data-filename') || src.split('/').pop();

            setTimeout(() => {
                downloadImage(src, filename);
            }, delay);
            delay += 500; // 500ms delay between downloads to prevent choking
        }
    }

    async function downloadSelected() {
        const selectedCheckboxes = document.querySelectorAll('.photo-select-checkbox:checked');
        if (selectedCheckboxes.length === 0) return;

        if (!confirm(`Download ${selectedCheckboxes.length} photos individually?`)) return;

        let delay = 0;
        selectedCheckboxes.forEach(cb => {
            const item = cb.closest('.photo-item');
            const src = item.getAttribute('data-src');
            const filename = item.getAttribute('data-filename') || src.split('/').pop();

            setTimeout(() => {
                downloadImage(src, filename);
            }, delay);
            delay += 500;
        });
    }

    async function deleteSelected() {
        const selected = Array.from(document.querySelectorAll('.photo-select-checkbox:checked')).map(cb => parseInt(cb.value));
        if (!selected.length) return;

        if (!confirm(`Are you sure you want to delete ${selected.length} photos?`)) return;

        try {
            const res = await fetch('/delete/selected', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ photo_ids: selected })
            });
            const data = await res.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting photos');
            }
        } catch (err) {
            console.error(err);
            alert('Error deleting photos');
        }
    }

    // Original Delete Photo Logic (Single)
    async function deletePhoto(e, id) {
        e.stopPropagation();
        if (!confirm('Are you sure you want to delete this photo?')) return;

        try {
            const res = await fetch(`/delete/${id}`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting photo');
            }
        } catch (err) {
            console.error(err);
            alert('Error deleting photo');
        }
    }

    // Lightbox Logic
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const items = document.querySelectorAll('.photo-item');
    let currentIndex = -1;

    function openLightbox(index) {
        if (isSelectionMode) return;
        currentIndex = index;
        const src = items[index].getAttribute('data-src');
        lightboxImg.src = src;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
        setTimeout(() => { lightboxImg.src = ''; }, 200);
    }

    document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('active')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight' && currentIndex < items.length - 1) openLightbox(currentIndex + 1);
        if (e.key === 'ArrowLeft' && currentIndex > 0) openLightbox(currentIndex - 1);
    });

    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) closeLightbox();
    });
</script>
{% endblock %}