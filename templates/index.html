{% extends 'base.html' %}

{% block content %}
<div class="flex-between">
    <h1>Albums</h1>
    {% if session.get('username') %}
    <button class="btn btn-primary" id="triggerUpload">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload Photos
    </button>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none">
    {% endif %}
</div>

{% if session.get('username') %}
<div class="upload-zone mt-4" id="uploadZone" style="display:none">
    <p>Drop photos here or click to select</p>
    <div id="uploadProgress" class="mt-4" style="color: var(--text-muted); font-size: 0.9rem;"></div>
</div>
{% endif %}

<div class="grid">
    {% for album in albums %}
    <a href="{{ url_for('view_album', username=album.owner) }}" class="card">
        <div class="card-image-wrapper">
            {% if album.cover %}
            <img src="{{ url_for('static', filename='uploads/' + album.cover) }}" alt="Cover" class="card-image"
                loading="lazy">
            {% else %}
            <div
                style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#eee; color:#aaa;">
                No Photos</div>
            {% endif %}
        </div>
        <div class="card-content">
            <h3 class="card-title">{{ album.name }}</h3>
            <p class="card-meta">{{ album.photo_count }} photos</p>
        </div>
    </a>
    {% else %}
    <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted);">
        <p>No albums yet. Be the first to upload!</p>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block scripts %}
{% if session.get('username') %}
<script>
    const triggerBtn = document.getElementById('triggerUpload');
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    const uploadProgress = document.getElementById('uploadProgress');

    // Toggle upload zone logic or just click input
    triggerBtn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', handleUpload);

    async function handleUpload(e) {
        const files = e.target.files;
        if (!files.length) return;

        uploadZone.style.display = 'block';
        uploadProgress.textContent = `Uploading ${files.length} photos...`;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('photos', files[i]);
        }

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                uploadProgress.textContent = `Success! ${result.count} photos uploaded. Reloading...`;
                setTimeout(() => location.reload(), 1000);
            } else {
                uploadProgress.textContent = `Error: ${result.error}`;
            }
        } catch (err) {
            uploadProgress.textContent = 'Upload failed. Please try again.';
            console.error(err);
        }
    }
</script>
{% endif %}
{% endblock %}