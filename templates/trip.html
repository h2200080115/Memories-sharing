{% extends 'base.html' %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-ghost" style="padding-left: 0">
        &larr; Back to Trips
    </a>
</div>

<div class="flex-between mb-4">
    <div>
        <h1>{{ trip.name }}</h1>
        <p style="color: var(--text-muted)">Code: <strong
                style="user-select: all; background: var(--border); padding: 0.2rem 0.5rem; border-radius: 4px;">{{
                trip.code }}</strong> (Share this!)</p>
    </div>

    <!-- AI Story Section -->
    <div style="flex: 1; margin: 0 2rem;">
        {% if story %}
        <div class="story-box"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; position: relative;">
            <h3 style="margin-top: 0; font-size: 1.2rem;">âœ¨ Our Trip Story</h3>
            <p style="font-style: italic; opacity: 0.9;">"{{ story.content }}"</p>
            {% if trip.created_by_id == session.get('user_id') %}
            <button onclick="generateStory()" class="btn btn-sm btn-ghost"
                style="position: absolute; top: 10px; right: 10px; color: white; border: 1px solid rgba(255,255,255,0.5);">
                Regenerate
            </button>
            {% endif %}
        </div>
        {% elif trip.created_by_id == session.get('user_id') %}
        <button onclick="generateStory()" class="btn btn-outline" id="generateStoryBtn">
            âœ¨ Generate AI Trip Story
        </button>
        {% endif %}
    </div>

    <button class="btn btn-primary" id="triggerUpload">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload Photos
    </button>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none">
</div>

{% if trip.created_by_id == session.get('user_id') %}
<div class="mb-4">
    <details>
        <summary style="cursor: pointer; color: var(--text-muted); padding: 0.5rem 0; font-weight: 500;">
            Manage Members ({{ trip.members|length }})
        </summary>
        <div class="mt-2" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            {% for member in trip.members %}
            <div
                style="background: var(--card-bg); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem;">
                <span>{{ member.username }}</span>
                {% if member.id != trip.created_by_id %}
                <button onclick="removeMember({{ member.id }}, '{{ member.username }}')"
                    style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0; display: flex; align-items: center;"
                    title="Remove Member">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                {% else %}
                <span style="font-size: 0.8em; color: var(--text-muted);">(Admin)</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </details>

    <div style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
        <button onclick="deleteTrip()" class="btn btn-primary" style="background: #ef4444; width: 100%;">
            Delete User Trip
        </button>
    </div>
</div>
{% endif %}

</div>
{% endif %}

<!-- Chat Floating Button & Window -->
<button class="chat-toggle" onclick="toggleChat()">
    ðŸ’¬ Chat
</button>

<div class="chat-window" id="chatWindow">
    <div class="chat-header">
        <span>Trip Chat</span>
        <button onclick="toggleChat()"
            style="background:none; border:none; color:white; cursor:pointer;">&times;</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div style="text-align: center; color: #888; padding: 1rem;">Loading messages...</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKey(event)">
        <button onclick="sendMessage()" class="btn btn-primary" style="padding: 0.5rem 1rem;">Send</button>
    </div>
</div>

<style>
    .chat-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        border: none;
        padding: 1rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 100;
        transition: transform 0.2s;
    }

    .chat-toggle:hover {
        transform: scale(1.05);
    }

    .chat-window {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 350px;
        height: 500px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        z-index: 100;
        overflow: hidden;
    }

    .chat-window.active {
        display: flex;
    }

    .chat-header {
        background: var(--primary);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }

    .message {
        max-width: 80%;
        padding: 0.6rem 1rem;
        border-radius: 12px;
        font-size: 0.9rem;
    }

    .message.own {
        align-self: flex-end;
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 2px;
    }

    .message.other {
        align-self: flex-start;
        background: var(--border);
        color: var(--text);
        border-bottom-left-radius: 2px;
    }

    .message-meta {
        font-size: 0.7em;
        opacity: 0.7;
        margin-bottom: 2px;
        display: block;
    }

    .chat-input-area {
        padding: 1rem;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 0.5rem;
        background: var(--card-bg);
    }

    #chatInput {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 20px;
        outline: none;
        background: var(--bg);
        color: var(--text);
    }
</style>

<div class="upload-zone mt-4" id="uploadZone" style="display:none">
    <p>Drop photos here or click to select</p>
    <div id="uploadProgress" class="mt-4" style="color: var(--text-muted); font-size: 0.9rem;"></div>
</div>

<div class="grid">
    {% for album in albums %}
    <a href="{{ url_for('view_album_details', album_id=album.id) }}" class="card">
        <div class="card-image-wrapper">
            {% if album.cover %}
            <img src="{{ album.cover }}" alt="Cover" class="card-image" loading="lazy">
            {% else %}
            <div
                style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: var(--border); color: var(--text-muted);">
                No Photos</div>
            {% endif %}
        </div>
        <div class="card-content">
            <h3 class="card-title">{{ album.owner }}</h3>
            <p class="card-meta">{{ album.photo_count }} photos</p>
        </div>
    </a>
    {% else %}
    <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: var(--text-muted);">
        <p>No photos in this trip yet. Start uploading!</p>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block scripts %}
<script>
    const triggerBtn = document.getElementById('triggerUpload');
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    const uploadProgress = document.getElementById('uploadProgress');
    const tripId = {{ trip.id }};

    triggerBtn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', handleUpload);

    async function handleUpload(e) {
        const files = e.target.files;
        if (!files.length) return;

        uploadZone.style.display = 'block';
        uploadProgress.textContent = `Uploading ${files.length} photos...`;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('photos', files[i]);
        }

        try {
            const response = await fetch(`/trip/${tripId}/upload`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                uploadProgress.textContent = `Success! ${result.count} photos uploaded. Reloading...`;
                setTimeout(() => location.reload(), 1000);
            } else {
                uploadProgress.textContent = `Error: ${result.error}`;
            }
        } catch (err) {
            uploadProgress.textContent = 'Upload failed. Please try again.';
            console.error(err);
        }
    }

    async function removeMember(memberId, username) {
        if (!confirm(`Are you sure you want to remove ${username} from this trip?`)) return;

        try {
            const response = await fetch(`/trip/${tripId}/remove_member/${memberId}`, {
                method: 'POST'
            });
            const result = await response.json();

            if (result.success) {
                alert(`${username} removed.`);
                location.reload();
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (err) {
            console.error(err);
            alert('Failed to remove member');
        }
    }

    async function deleteTrip() {
        if (!confirm('Are you sure you want to DELETE this entire trip? This action cannot be undone and will delete all photos permanently.')) return;

        // Double confirmation for safety
        const tripName = "{{ trip.name }}";
        const check = prompt(`To confirm, please type the trip name: ${tripName}`);
        if (check !== tripName) {
            alert("Trip name did not match. Deletion cancelled.");
            return;
        }

        try {
            const response = await fetch(`/trip/${tripId}/delete`, {
                method: 'POST'
            });
            const result = await response.json();

            if (result.success) {
                alert('Trip deleted successfully.');
                window.location.href = "{{ url_for('index') }}";
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (err) {
            console.error(err);
            alert('Failed to delete trip');
        }
    }

    // --- Story Logic ---
    async function generateStory() {
        const btn = document.getElementById('generateStoryBtn');
        if (btn) {
            btn.textContent = "Generating...";
            btn.disabled = true;
        }

        try {
            const res = await fetch(`/trip/${tripId}/generate_story`, { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                location.reload();
            } else {
                alert("Error: " + (data.error || "Failed"));
                if (btn) {
                    btn.textContent = "âœ¨ Generate AI Trip Story";
                    btn.disabled = false;
                }
            }
        } catch (e) {
            console.error(e);
            alert("Connection error");
            if (btn) {
                btn.textContent = "âœ¨ Generate AI Trip Story";
                btn.disabled = false;
            }
        }
    }

    // --- Chat Logic ---
    let chatInterval = null;
    const chatWindow = document.getElementById('chatWindow');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    let currentUser = "";

    function toggleChat() {
        chatWindow.classList.toggle('active');
        if (chatWindow.classList.contains('active')) {
            loadMessages();
            chatInterval = setInterval(loadMessages, 3000); // Poll every 3s
            // Scroll to bottom
            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
        } else {
            clearInterval(chatInterval);
        }
    }

    async function loadMessages() {
        try {
            const res = await fetch(`/trip/${tripId}/messages`);
            const data = await res.json();

            if (data.messages) {
                currentUser = data.current_user;
                renderMessages(data.messages);
            }
        } catch (e) {
            console.error("Chat load error", e);
        }
    }

    function renderMessages(messages) {
        // Simple render - optimize later using IDs to append only new ones if needed
        chatMessages.innerHTML = messages.map(m => `
            <div class="message ${m.user === currentUser ? 'own' : 'other'}">
                <span class="message-meta">${m.user} â€¢ ${m.timestamp}</span>
                ${m.content}
            </div>
        `).join('');
    }

    async function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;

        chatInput.value = '';

        try {
            await fetch(`/trip/${tripId}/message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: text })
            });
            loadMessages(); // Reload immediately
        } catch (e) {
            console.error("Send error", e);
            alert("Failed to send");
        }
    }

    function handleChatKey(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>
{% endblock %}